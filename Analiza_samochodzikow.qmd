---
title: "Analiza rynku samochodowego" 
author: "Marceli Denysiuk" 
format: 
  html: 
    theme: cosmo
    toc: true 
    toc-location: left
    header-includes: |
      <style>
      table {
        width: auto !important;
        margin-left: auto !important;
        margin-right: auto !important;
      }
      </style>
    toc-title: "Spis treci" 
    toc-depth: 2 
    number-sections: true 
    smooth-scroll: true
    bibliography: references.bib
execute:
  echo: false
  warning: false
  message: false
---

## Cel projektu

Analiza rynku samochodowego w celu wyonienia najlepszych segment贸w na podstawie parametr贸w technicznych oraz ocen eksperckich.

### Problematyka

Poszukiwanie ciekawych, praktycznych lub nawet decyzyjnych dla konsumenta wniosk贸w oraz wyanianie lider贸w na rynku dziki analizie dostepngo zbioru danych.

## Dane

Mamy zbi贸r okoo 3500 wierszy. Zbi贸r danych pochodzi z amerykaskiego serwisu internetowego zajmujcego sie handlem nowych i u偶ywanych samochod贸w. Mo偶na by to por贸wna do polskiego Otomoto, tyle, 偶e tutaj mielimy recenzje ekspert贸w na temat tych samochod贸w. W kolumnach tekstowych mamy cechy takie jak:

-   Marka i model samochodu

-   Kr贸tkie recenzje ekspert贸w na temat samochodu

-   Rodzaj skrzyni bieg贸w

-   Rodzaj silnika

-   Rodzaj ukadu napdowego

-   Mocne i sabe strony samochodu

Natomiast w kolumnach numerycznych mamy:

-   Rok produkcji

-   Liczb koni mechanicznych

-   Moment obrotowy w NM

-   Ocen nadan przez eksperta od 1.0 do 5.0

-   3 wymiary samochodu

-   Wage samochodu

::: callout-warning
## Pamitajmy

Pamietajmy, 偶e analiza w du偶ej mierze opiera sie na subiektywnych odczuciach ekspert贸w, wic trzeba podchodzi do wniosk贸w z lekkim dystansem.
:::

## Pytania i Hipotezy

### Najczciej wystpujce problemy w samochodach?

*Hipoteza*: Najwicej problem贸w jest ze zo偶on elektronik.

### Jakie marki s najbardziej lubiane?

*Hipoteza*: Powielajc panujce przekonanie o jakoci japoskich marek: najbardziej lubiane s japoskie marki.

### Kt贸re samochody s bardziej lubiane - stare, czy nowe?

*Hipoteza*: Bardziej lubiane s stare samochody.

### Czy moc samochodu ma wpyw na poprawe oceny?

*Hipoteza*: Moc samochodu nie ma wpywu na poprawe oceny.

## Czyszczenie danych

[Niewyczyszczony zbi贸r danych:]{.underline}

```{r}
library(tidyverse)
library(kableExtra)

# 1. Wczytanie danych
raw_data <- read.csv("review_data.csv", sep = ";")

# 2. Podgld surowego zbioru (5 wierszy, wzorzec bazowy)
raw_data %>%
  # Wykluczamy kolumny wg wzorca
  select(
    -url, 
    -word.count.for.full.description, 
    -word.count.for..GPT.2.Summarization, 
    -keywords, 
    -cargo.capacity..all.seats.In.place
  ) %>%
  head(4) %>%
  # Zwijanie wszystkich tekst贸w do dymk贸w
  mutate(across(where(is.character), ~ cell_spec(
    str_trunc(replace_na(.x, ""), 40), 
    tooltip = replace_na(.x, "")
  ))) %>%
  # Tabela wg wzoru
  kbl(escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  scroll_box(width = "100%")

```

```{r}
library(tidyverse)
library(kableExtra)
#DATA CLEANED
# 1. Wczytanie danych
raw_data <- read.csv("review_data.csv", sep = ";")

# 2. Czyszczenie i inteligentne uzupenianie wag (data_cleaned)
data_cleaned <- raw_data %>%
  # Wstpna konwersja typ贸w
  mutate(
    year = parse_number(as.character(manufacturing.year)),
    rating = parse_number(as.character(rating)),
    horsepower = parse_number(as.character(horsepower)),
    torque = parse_number(as.character(torque)),
    temp_weight = parse_number(as.character(curb.weight))
  ) %>%
  # KROK 1: Obliczamy redni wag dla ka偶dego modelu (np. Honda Civic) 
  # Ignorujemy rocznik, 偶eby wycign redni z caego okresu produkcji danego modelu
  group_by(car.brand, car.model) %>%
  mutate(
    avg_model_weight = mean(temp_weight, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # KROK 2: Uzupeniamy braki redni, a dla brakujcych modeli wpisujemy dane rcznie
  mutate(
    weight_final_lbs = case_when(
      !is.na(temp_weight) ~ temp_weight,            # Jeli waga jest, zostawiamy
      !is.na(avg_model_weight) ~ avg_model_weight,  # Jeli brak, bierzemy redni modelu
      # Rczne uzupenienie dla modeli, kt贸re w og贸le nie maj wagi w zbiorze:
      str_detect(car.model, "transit-passenger") ~ 5500,
      str_detect(car.model, "transit-cargo") ~ 5000,
      str_detect(car.model, "mustang-mach-e") ~ 4500,
      str_detect(car.model, "encore-gx") ~ 3100,
      TRUE ~ NA_real_                               # Reszta (jeli zostanie)
    )
  ) %>%
  # KROK 3: Finalne przeliczenia na metry i kg
  mutate(
    car.full.name = str_squish(str_remove_all(car.full.name, "\\b\\d{4}\\b")),
    `width(m)` = round(parse_number(as.character(overall.width.without.mirrors)) * 0.0254, 2),
    `height(m)` = round(parse_number(as.character(height)) * 0.0254, 2),
    `length(m)` = round(parse_number(as.character(length)) * 0.0254, 2),
    `weight(kg)` = round(weight_final_lbs * 0.453592, 2),
    # Teraz kolumna power bdzie znacznie czciej uzupeniona!
    power = round((horsepower / `weight(kg)`) * 100, 2)
  ) %>%
  filter(!is.na(rating), year >= 1900, year <= 2025) %>%
  relocate(year, .after = car.full.name) %>%
  relocate(power, .after = torque) %>%
  select(
    everything(),
    -overall.width.without.mirrors, -overall.width.with.mirrors, 
    -height, -length, -curb.weight, -manufacturing.year,
    -temp_weight, -avg_model_weight, -weight_final_lbs
  )
```

### Usunicie wierszy bez ocen

Z okoo 3463 wierszy zostaje nam 3044. Wiersze z pustymi silnymi i sabymi stronami zostaj, bo te mo偶emy wywnioskowa dokonujc analizy recenzji ekspert贸w.

### Czyszczenie *horsepower* i *torque*

Usuwamy niepotrzebne dopiski na jakich obrotach sa osigane maksymalne momenty obrotowe i konie mechaniczne oraz zamieniamy rodzaj kolumn na numeryczne.

```{r}
#| label: engine-cleaning
#| echo: false
#| message: false
#| warning: false

# Przygotowanie danych do podgldu z penym przekreleniem jednostek i obrot贸w
engine_raw <- raw_data %>%
  head(3) %>%
  mutate(
    `... ` = "...",
    horsepower = c("401 <s>hp @ 5800 rpm</s>", "445 <s>hp @ 2800 rpm</s>", "310 <s>hp @ 5500 rpm</s>"),
    torque = c("464 <s>lb-ft @ 4000 rpm</s>", "910 <s>lb-ft @ 1600 rpm</s>", "365 <s>lb-ft @ 3000 rpm</s>"),
    `  ...` = "..."
  ) %>%
  select(`... `, horsepower, torque, `  ...`)

# Tabela z wyczon pen szerokoci i wymuszonym pozycjonowaniem do lewej
kbl(engine_raw, escape = FALSE) %>%
  kable_styling(
    bootstrap_options = c("striped", "condensed"), 
    font_size = 12, 
    full_width = FALSE, 
    position = "center"
  ) %>%
  column_spec(2:3, bold = TRUE) %>%
  column_spec(c(1, 4), color = "#aaaaaa")
  
```

### Konwersja jednostek

Zamiana wartoci z cali i st贸p na system metryczny w kolumnach gdzie mamy podane wymiary samochod贸w i ustawienie rodzaju kolumn na numeryczne.

```{r}
#| label: data-comparison
#| echo: false
#| message: false
#| warning: false

# Przygotowanie wycink贸w danych bez kolumny modelu
snippet_raw <- raw_data %>%
  head(3) %>%
  mutate(`... ` = "...", `  ...` = "...") %>%
  select(`... `, length, height, overall.width.without.mirrors, curb.weight, `  ...`)

snippet_cleaned <- data_cleaned %>%
  head(3) %>%
  mutate(`... ` = "...", `  ...` = "...") %>%
  select(`... `, `length(m)`, `height(m)`, `width(m)`, `weight(kg)`, `  ...`)
```

:::::: {.columns style="display: flex; align-items: center;"}
::: {.column width="42%"}
```{r}
#| echo: false
kbl(snippet_raw) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), font_size = 12, full_width = T) %>%
  column_spec(2:5, background = "#FFE3E3", color = "black", bold = TRUE) %>%
  column_spec(c(1, 6), color = "#aaaaaa")
```
:::

::: {.column width="10%" style="text-align: center; font-size: 2.5em;"}
$\rightarrow$
:::

::: {.column width="42%"}
```{r}
#| echo: false
kbl(snippet_cleaned) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), font_size = 12, full_width = T) %>%
  column_spec(2:5, background = "#E3FFE3", color = "black", bold = TRUE) %>%
  column_spec(c(1, 6), color = "#aaaaaa")
```
:::
::::::

### Definicja zmiennej Power

Z uwagi na fakt, 偶e liczba koni mechanicznych nie daje nam penego obrazu o rzeczywistej "mocy" samochodu, wprowadzamy kolumn ***power*** oznaczajac moc

:::: {.columns style="display: flex; align-items: center;"}
::: column
$$
\text{power} = \frac{\text{horsepower}}{\text{weight (kg)}} \cdot 100
$$
:::
::::

Kolumna *power* odzwierciedla stosunek [mocy do masy]{.underline} samochodu dajc nam og贸lny wsp贸czynnik (power-to-weight ratio [@Gillespie1992]) dajcy wyobra偶enie o tym jak szybki bdzie samoch贸d w rzeczywistoci. Pozwala to na obiektywna ocene dynamiki samochod贸w z r贸偶nych segment贸w [@bosch2014].

```{r}
#| echo: false
#| message: false
#| warning: false

# Wywietlenie tabeli z wybranym zakresem kolumn
data_view <- data_cleaned %>%
  select(engine_type:power) %>%
  head(6)

data_view %>%
  mutate(across(where(is.character), ~ cell_spec(str_trunc(replace_na(.x, ""), 30), 
                                                 tooltip = .x))) %>%
  kbl(escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed",full_width = F, position = "center"), font_size = 11) %>%
  column_spec(ncol(data_view), background = "#eb3474", color = "black", bold = TRUE)
```

## Jakie s najczciej wystpujce problemy w samochodach?

### Hipoteza: Najwicej problem贸w jest ze zo偶on elektronik.

W celu znalezienia odpowiedzi na to pytanie posu偶ymy sie kolumn *weaknesses,* w kt贸rej mamy gotowe wypisane saboci r贸偶nych pojazd贸w.

Tworzymy liste pojedyczych s贸w, odfiltrujemy niepotrzebne sp贸jniki, wypeniacze oraz sowa nie wnoszce nic w kontekcie wystepujcych problem贸w. Dzielimy sowa na 2 przedziay ocen z jakimi byy zwizane aby mie pojcie co w du偶ym stopniu zawa偶yo na ocenie, a co byo tylko niedocignieciem.

```{r}
#| label: problems-wordcloud-two-groups
#| echo: false
#| message: false
#| warning: false
#| fig-height: 6

library(tidytext)
library(ggwordcloud)
library(scales)
library(dplyr)
library(stringr)
library(tidyr)

# 1. Kategoryzacja bd贸w na dwa przedziay (granica 3.0)
problems_data <- data_cleaned %>%
  filter(!is.na(rating), !is.na(weaknesses)) %>%
  mutate(
    severity_group = case_when(
      rating < 3.0 ~ "1. Bdy Krytyczne (Ocena < 3.0)",
      TRUE         ~ "2. Niedocignicia (Ocena 3.0+)"
    )
  )

# 2. Przygotowanie tekstu - slowa do wyrzucenia
problem_stopwords <- c(
  "car", "cars", "vehicle", "model", "brand", "review", "seat", "seats", "rear", "back", "front",
  "bit", "little", "much", "some", "with", "from", "that", "this", "have", "has", "system",
  "driver", "passenger", "looking", "design", "style", "version", "extremely", "audi",
  "available", "offer", "option", "standard", "feature", "features", "make", "made",
  "hard", "soft", "high", "low", "long", "short", "big", "small", "many", "well", "q5", "limited", "similarly", "equipped", "infotainment", "locations", "sedate", "california", "cargo", "due", "empty", "road", "row", "outward", "compared", "car's"
)

# Definicja funkcji gradient贸w
red_pal <- col_numeric(palette = c("#ffb3b3", "#b71c1c"), domain = c(0, 1))    # Czerwony
orange_pal <- col_numeric(palette = c("#ffe0b2", "#e65100"), domain = c(0, 1)) # Pomaraczowy

tidy_problems <- problems_data %>%
  unnest_tokens(word, weaknesses) %>%
  filter(!str_detect(word, "^[0-9]+$")) %>%
  filter(!word %in% stop_words$word) %>%
  filter(!word %in% problem_stopwords) %>%
  # Liczymy wystpienia w grupach
  count(severity_group, word, sort = TRUE) %>%
  group_by(severity_group) %>%
  # Bierzemy top 24 dla ka偶dej grupy zgodnie z prob
  slice_max(n, n = 20) %>%
  # Normalizacja wielkoci sowa
  mutate(size_scaled = n / max(n)) %>%
  # Przypisanie kolor贸w: Lewa - Czerwony, Prawa - Pomaraczowy
  mutate(word_color = case_when(
    str_detect(severity_group, "Krytyczne") ~ red_pal(size_scaled),
    TRUE ~ orange_pal(size_scaled)
  )) %>%
  ungroup()

# 3. Wizualizacja
ggplot(tidy_problems, aes(label = word, size = size_scaled, color = word_color)) +
  geom_text_wordcloud(area_corr = TRUE) +
  scale_size_area(max_size = 24) + # Zachowana wielko czcionki
  facet_wrap(~severity_group, scales = "free") +
  theme_minimal() +
  scale_color_identity() + 
  labs(
    title = "Dominujce problemy w zale偶noci od oceny"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16), # Wycentrowany tytu
    strip.text = element_text(size = 13, face = "bold", color = "black"),
    
    panel.spacing = unit(0, "lines"),
    plot.margin = margin(10, 10, 10, 10)
  )

```

### Bdy krytyczne (ocena \<3.0)

Najczstszymi bedami krytycznymi, kt贸re znacznie wpyny na ocene sa problemy z silnikiem. Zatem warto uwa偶a na wadliwe modele i dokadnie sprawdza panujce opinie o jednostkach w samochodzie, kt贸ry chcemy kupi. Drug ciekaw wad okazuje si by po prostu cena, czyli jak sie okazuj zdarzaj sie modele przepacone na tyle, 偶e zani偶a to ca ocene a偶 poni偶ej 3 gwiazdek.

### Bdy mniej znaczce (ocena 3.0+)

Przy obu problemach ukazuje si do logiczny rezultat: wntrze, czyli bardzo szeroki zakres: r贸偶nego rodzaje plastiki, wyposa偶enie typu elektryczne szyby, klimatyzacja itd. Narzekanie ekspert贸w na te rzeczy wydaje si oczywiste bo zawsze mo偶na przyczepi sie do tego typu niedocigni, szczeg贸lnie, 偶e to wanie wntrze najbardziej rzuca sie w oczy przy u偶ytkowaniu samochodu. Na drugim miejscu jest sowo "ride", kt贸re w kontekcie wypowiedzi negatywnych oznacza wszelakie problemy z uczuciami podczas jazdy typu niewystrojone/za twarde/za mikkie zawieszenie, sabe prowadzenie pojazdu lub znowu problemy wntrza rzutujce na odczucia z jazdy czyli np. bardzo trudne do obsugi kontrolki rozpraszajce kierowce.

::: callout-important
## Uwaga!

Warto zaznaczy, 偶e obie chmury s贸w zostaly przeskalowane tak aby miay ten sam rozmiar na potrzeby czytelnoci. W rzeczywistoci grupa wysokich ocen jest znacznie liczniejsza jak wida na wycinku poni偶szej tabeli(krytyczne bdy zdarzaj sie sporadycznie).
:::

```{r}
#| label: problems-table-comparison
#| echo: false
#| message: false
#| warning: false

library(tidytext)
library(kableExtra)
library(scales)
library(dplyr)
library(stringr)
library(tidyr)

# 1. Kategoryzacja bd贸w na dwa przedziay (granica 3.0)
problems_data <- data_cleaned %>%
  filter(!is.na(rating), !is.na(weaknesses)) %>%
  mutate(
    severity_group = case_when(
      rating < 3.0 ~ "1. Bdy Krytyczne (Ocena < 3.0)",
      TRUE         ~ "2. Niedocignicia (Ocena 3.0+)"
    )
  )

# 2. Przygotowanie tekstu - slowa do wyrzucenia
problem_stopwords <- c(
  "car", "cars", "vehicle", "model", "brand", "review", "seat", "seats", "rear", "back", "front",
  "bit", "little", "much", "some", "with", "from", "that", "this", "have", "has", "system",
  "driver", "passenger", "looking", "design", "style", "version", "extremely", "audi",
  "available", "offer", "option", "standard", "feature", "features", "make", "made",
  "hard", "soft", "high", "low", "long", "short", "big", "small", "many", "well", "q5", 
  "limited", "similarly", "equipped", "infotainment", "locations", "sedate", "california", 
  "cargo", "due", "empty", "road", "row", "outward", "compared", "car's"
)

# 3. Przetwarzanie i liczenie s贸w
word_counts <- problems_data %>%
  unnest_tokens(word, weaknesses) %>%
  filter(!str_detect(word, "^[0-9]+$")) %>%
  filter(!word %in% stop_words$word) %>%
  filter(!word %in% problem_stopwords) %>%
  count(severity_group, word, sort = TRUE) %>%
  group_by(severity_group) %>%
  mutate(rank = row_number()) %>%
  ungroup()

# 4. Przygotowanie tabeli pivot (Top 20 obok siebie)
comparison_table <- word_counts %>%
  filter(rank <= 11) %>%
  select(severity_group, word, n, rank) %>%
  pivot_wider(
    names_from = severity_group,
    values_from = c(word, n)
  ) %>%
  # Wybieramy i porzdkujemy kolumny
  select(
    rank,
    `word_1. Bdy Krytyczne (Ocena < 3.0)`, `n_1. Bdy Krytyczne (Ocena < 3.0)`,
    `word_2. Niedocignicia (Ocena 3.0+)`, `n_2. Niedocignicia (Ocena 3.0+)`
  )

# 5. Wywietlenie tabeli
kbl(comparison_table, 
    col.names = c("nr", "Wada (Krytyczna)", "Wystpienia", "Wada (Drobna)", "Wystpienia")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    font_size = 12, 
    full_width = FALSE, 
    position = "center"
  ) %>%
  add_header_above(c(" " = 1, "Segment Niskich Ocen" = 2, "Segment Wysokich Ocen" = 2)) %>%
  column_spec(2, bold = TRUE, color = "#b71c1c") %>% # Czerwony dla krytycznych
  column_spec(4, bold = TRUE, color = "#e65100")     # Pomaraczowy dla drobnych
```

### *Wnioski:* {#sec-wnioski1}

Hipoteza bdna. Pomimo wielu r贸znych problem贸w nie ma 偶adnych wzmianek konkretnie o problemach z elektronik i mimo, 偶e wntrze mo偶e zawiera wanie takie problemy, to nie mo偶emy jednozacznie stwierdzi, 偶e wasnie o to chodzi. Zatem pozostaje nam fakt, 偶e najwicej krytycznych problem贸w generuj wadliwe silniki, a najwicej drobnych problem贸w jest z wntrzem samochod贸w. [podsumowanie](#podsumowanie)

## Jakie marki s najbardziej niezawodne?

### Hipoteza: Powielajc panujce przekonanie o jakoci japoskich marek: najbardziej niezawodne s japoskie marki.

::: callout-tip
## Zao偶enie

Przyjmujemy zao偶enie: lubiany = niezawodny co oczywicie nie zawsze bdzie prawd, ale sporo upraszcza
:::

Na osi poziomej mamy urednione wartoci jakie przyjmuje *rating* (1.0 - 5.0), tutaj mamy te偶 6, wycznie aby zmieci tekst. Na osi pionowej marki samochod贸w. Wartoci zmiennych na obu osiach s wyliczanie niezale偶nie od innych lat dla ka偶dego roku. Aktualny lider w danym roku wyr贸偶niony jest [**zotym kolorem**]{style="color: #fad543; font-weight: bold;"} i koron.

W skr贸cie: im du偶sza kreseczka, tym wy偶sza ocena. Na dole wida jak wysoka dokadnie.

```{r}
#| label: brand-race-final-pro-fix
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(plotly)
library(ggwordcloud)
library(tidytext)

# --- 1. PRZYGOTOWANIE DANYCH ---
# Przeliczamy oceny na skal 0-5
brand_race_data <- data_cleaned %>%
  filter(!is.na(year), !is.na(rating), !is.na(car.brand)) %>%
  group_by(year, car.brand) %>%
  summarise(
    avg_rating = mean(rating, na.rm = TRUE),
    count = n(),
    .groups = 'drop'
  ) %>%
  group_by(year) %>%
  mutate(
    # Ranking od 1 do N (najlepszy na g贸rze)
    current_rank = rank(-avg_rating, ties.method = "first"),
    is_winner = current_rank == 1,
    bar_color = if_else(is_winner, "#fad543", "#fa9162"),
    # Etykieta przy pasku
    label_text = if_else(is_winner, 
                         paste0("<b> ", car.brand, "</b>"), 
                         as.character(car.brand))
  ) %>%
  ungroup() %>%
  arrange(year, current_rank)

# --- 2. ANIMACJA BAR PLOT ---
fig <- plot_ly(
  data = brand_race_data,
  x = ~avg_rating,
  y = ~current_rank,
  frame = ~year,
  ids = ~car.brand, 
  type = 'bar',
  orientation = 'h',
  marker = list(
    color = ~bar_color,  
    line = list(color = "white", width = 1)
  ),
  hoverinfo = 'text',
  hovertext = ~paste("Marka:", car.brand, 
                    "<br>Ocena:", round(avg_rating, 2),
                    "<br>Pozycja:", current_rank)
) %>%
  layout(
    title = list(text = "<b>Ranking marek</b>", x = 0.5),
    xaxis = list(
      title = "rednia ocena", 
      range = c(0, 6.0), # Zapas na tekst
      gridcolor = "#f0f0f0",
      zeroline = FALSE
    ),
    yaxis = list(
      title = "Miejsce w rankingu", 
      showticklabels = TRUE,
      tickmode = "linear",
      dtick = 1,
      autorange = "reversed", # 1 na samej g贸rze
      fixedrange = TRUE
    ),
    # Zwikszony margines dolny (b=100) aby odsun suwak od osi X
    margin = list(l = 70, r = 30, t = 80, b = 100),
    plot_bgcolor = "white",
    showlegend = FALSE
  ) %>%
  # 1. Nazwy marek po PRAWEJ stronie supk贸w
  add_text(
    x = ~avg_rating,
    y = ~current_rank,
    text = ~label_text,
    textposition = "middle right",
    textfont = list(size = 11, color = "black"), 
    showlegend = FALSE
  ) %>%
  # 2. ROK W TLE (Statyczny, bez animacji ruchu)
  add_text(
    # Filtrujemy dane, aby doda tekst raz na rok (dla pierwszego miejsca)
    # ids='static_year' jest kluczowe, aby Plotly nie traktowa tego jako nowego obiektu
    data = brand_race_data %>% group_by(year) %>% filter(current_rank == 1),
    x = 3, 
    y = 1, # G贸ra wykresu (przy rankingu 1)
    text = ~year,
    ids = 'static_year', 
    textposition = "bottom left",
    textfont = list(size = 75, color = "rgba(0,0,0,0.1)", weight = "bold"), 
    mode = "text",
    marker = list(color = "white", size = 0.1), # Biaa kropka (niewidoczna)
    showlegend = FALSE,
    hoverinfo = "none"
  ) %>%
  animation_opts(
    frame = 1000, 
    transition = 600, 
    easing = "cubic-in-out", 
    redraw = FALSE
  ) %>%
  animation_slider(
    currentvalue = list(visible = FALSE), # Ukryty tekst na sliderze
    pad = list(t = 70)
  )

fig
```

```{r}
#| label: consistency-score-plot-cumulative

library(tidyverse)
library(plotly)

# 1. Obliczanie punkt贸w w ka偶dym roku (REDNIA)
scored_brands <- data_cleaned %>%
  filter(!is.na(year), !is.na(rating), !is.na(car.brand)) %>%
  group_by(year, car.brand) %>%
  summarise(
    avg_rating = mean(rating, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  group_by(year) %>%
  mutate(
    # Ranking w danym roku (1 = najlepszy)
    annual_rank = rank(-avg_rating, ties.method = "min"),
    total_brands_in_year = n(),
    # Punkty roczne: (Liczba marek - Ranking + 1)
    points_yearly = total_brands_in_year - annual_rank + 1
  ) %>%
  ungroup()

# 2. Obliczanie SUMY SKUMULOWANEJ (Running Total)
scored_brands_cumulative <- scored_brands %>%
  arrange(year) %>%
  group_by(car.brand) %>%
  mutate(
    # To jest kluczowa zmiana: sumujemy punkty narastajco
    total_points_cumulative = cumsum(points_yearly)
  ) %>%
  ungroup()

# 3. Wyonienie TOP 5 marek z najwiksz liczb punkt贸w na koniec okresu
top5_brands <- scored_brands_cumulative %>%
  group_by(car.brand) %>%
  summarise(final_score = max(total_points_cumulative)) %>%
  arrange(desc(final_score)) %>%
  head(5) %>%
  pull(car.brand)

# 4. Przygotowanie danych do wykresu dla TOP 5
trend_data_points <- scored_brands_cumulative %>%
  filter(car.brand %in% top5_brands) %>%
  filter(year >= 1990, year <= 2024) %>%
  mutate(car.brand = factor(car.brand, levels = top5_brands))

# 5. Wykres liniowy SKUMULOWANYCH punkt贸w
brand_colors <- c("#eb3474", "#5e17eb", "#fa9162", "#00b894", "#0984e3")

fig_trend <- plot_ly(
  data = trend_data_points,
  x = ~year,
  y = ~total_points_cumulative, # Wywietlamy sum narastajc
  color = ~car.brand,
  colors = brand_colors,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(width = 3),
  marker = list(size = 4.8),
  text = ~paste("Marka:", car.brand, 
                "<br>Rok:", year, 
                "<br>Punkty w tym roku:", points_yearly,
                "<br>Suma punkt贸w:", total_points_cumulative),
  hoverinfo = 'text'
) %>%
  layout(
    title = list(text = "<b>Skumulowana liczba punkt贸w</b>", x = 0.05),
    xaxis = list(title = "Rok produkcji", gridcolor = "#f0f0f0"),
    yaxis = list(title = "Suma punkt贸w (narastajco)", gridcolor = "#f0f0f0"),
    legend = list(title = list(text = "<b>Liderzy Punktacji</b>"), x = 0.05, y = 1),
    plot_bgcolor = "white",
    margin = list(l = 50, r = 20, t = 60, b = 50)
  )

fig_trend

```

Widzimy jak najlepsze 5 marek konkurowalo o najlepsze oceny na przestrzeni lat. Na osi X mamy lata produkcji. Na osi Y sume punkt贸w dla danego roku.

<div>

$$
punkty = liczba\;marek\; - \;ranking\; +1
$$

</div>

### Punkty?

Miara punkt贸w zwyczajnie odzwierciedla odlego marki od pierwszego miejsca w rankingu. Kluczowe rzeczy:

-   Im wy偶ej w rankingu - tym wicej punkt贸w.

-   Liczba punkt贸w jest przyznawana ka偶dej marce wedug wzoru co rok.

Dziki takiej mierze eliminujemy problemy ze redni, kt贸ra zaciera informacje o tym, czy dana marka np. miaa kilka dobrych lat i tylko to podnosi jej redni co daje jej mo偶liwo konkurencji z bardziej konsekwentymi markami, takimi kt贸re trzymaj poziom cay czas. Dziki tym punktom mo偶emy na statycznym wykresie zobaczy "przebieg wycigu" i widzimy kto z najwiksza konswekwencj zbli偶a sie do idealnych wynik贸w.

### *Wnioski:* {#sec-wnioski2}

Hipoteza potwierdzona - wygrywa japoska Mazda i w czo贸wce mamy jeszcze dw贸ch japoczyk贸w (Acura i Toyota). [podsumowanie](#podsumowanie)

## Kt贸re samochody s bardziej lubiane - stare, czy nowe?

### Hipoteza: Bardziej lubiane s stare samochody.

呕eby odpowiedzie na to pytanie zwyczajnie liczymy rednie dla lat 1990-2021. Przyjmujemy zao偶enie, 偶e stare samochody kocz sie po 2010 roku, ale oczywicie ka偶dy r贸偶nie zdefiniuje stary samochod. Stawiamy kresk na kocu 2010 roku aby oddzieli dwie ery. Liczymy redni dla lat z obu ram czasowych i sprawdzamy kt贸ra wygrywa.

```{r}
library(tidyverse)
library(ggplot2)

# 1. Przygotowanie danych
plot_data <- data_cleaned %>%
  # Filtrujemy sensowny zakres lat (np. 1990-2024)
  filter(year >= 1990, year <= 2024) %>%
  filter(!is.na(rating))

# 2. Obliczenie rednich rocznych (do linii trendu)
yearly_trend <- plot_data %>%
  group_by(year) %>%
  summarise(avg_rating = mean(rating, na.rm = TRUE)) %>%
  ungroup()

# 3. Obliczenie rednich dla dw贸ch "epok" (do tafli wody)
# "Stare" = do koca 2010 roku
avg_old <- plot_data %>%
  filter(year < 2010) %>%
  summarise(m = mean(rating, na.rm = TRUE)) %>%
  pull(m)

# "Nowe" = po 2010 roku
avg_new <- plot_data %>%
  filter(year >= 2010) %>%
  summarise(m = mean(rating, na.rm = TRUE)) %>%
  pull(m)

# Punkt podziau (pomidzy rokiem 2010 a 2011)
split_point <- 2010.5 

# 4. Tworzenie wykresu
ggplot() +
  # --- WARSTWA 1: "TAFLA WODY" (TO) ---
  # Stare auta (lewa strona)
  geom_rect(aes(xmin = min(yearly_trend$year), xmax = split_point, 
                ymin = -Inf, ymax = avg_old),
            fill = "#3498db", alpha = 0.2) +
  # Nowe auta (prawa strona)
  geom_rect(aes(xmin = split_point, xmax = max(yearly_trend$year), 
                ymin = -Inf, ymax = avg_new),
            fill = "#3498db", alpha = 0.2) +
  
  # --- WARSTWA 2: POZIOM "WODY" (LINIE POZIOME) ---
  # Linia poziomu dla starych
  geom_segment(aes(x = min(yearly_trend$year), xend = split_point, 
                   y = avg_old, yend = avg_old),
               color = "#2980b9", size = 1.2) +
  # Linia poziomu dla nowych
  geom_segment(aes(x = split_point, xend = max(yearly_trend$year), 
                   y = avg_new, yend = avg_new),
               color = "#2980b9", size = 1.2) +

  # --- WARSTWA 3: GRANICA WIATW ---
  geom_vline(xintercept = split_point, linetype = "dashed", color = "black", size = 0.8) +

  # --- WARSTWA 4: RZECZYWISTY TREND (LINIA AMANA) ---
  geom_line(data = yearly_trend, aes(x = year, y = avg_rating), 
            color = "#2c3e50", size = 1) +
  geom_point(data = yearly_trend, aes(x = year, y = avg_rating), 
             color = "#2c3e50", size = 1.5) +

  # --- WARSTWA 5: ETYKIETY ---
  annotate("text", x = 2000, y = avg_old - 0.5, 
           label = paste0("Stare Samochody\nrednia: ", round(avg_old, 2)), 
           color = "#2980b9", fontface = "bold", size = 5) +
  annotate("text", x = 2016, y = avg_new - 0.4, 
           label = paste0("Nowe Samochody\nrednia: ", round(avg_new, 2)), 
           color = "#2980b9", fontface = "bold", size = 5) +

  # Ustawienia osi i stylu
  scale_y_continuous(limits = c(3.5, 5.0)) + # Zoomujemy, 偶eby widzie r贸偶nic
  scale_x_continuous(breaks = seq(1990, 2026, 5)) +
  labs(title = "Czy kiedy robili lepsze samochody?",
       subtitle = "Por贸wnanie redniej ocen przed i po roku 2010",
       x = "Rok produkcji",
       y = "rednia ocena") +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  )
```

Widzimy ewidentnie zwycizce: stare samochody. Nawet w najgorszym momencie stare samochody byy bardziej lubiane od nowych. Wynika to prawdopodobnie z wielu komplikacji jakie wprowadzia nowoczesna elektronika w samochodach, kt贸ra zabia prawdziw frajd z jazdy. Starsze samochody sa prostsze w budowie i mniej skupione na skomplikowanych systemach podatnych na problemy.

### *Wnioski:* {#sec-wnioski3}

Hipoteza prawdziwa. Starsze samochody sa bardziej lubiane. [podsumowanie](#podsumowanie)

## Czy moc samochodu ma wpyw na poprawe oceny?

### Hipoteza: Moc samochodu nie ma wpywu na poprawe oceny.

W celu sprawdzenia hipotezy we藕miemy kolumny *rating* oraz *power*, kt贸ra wczeniej sobie przygotowalimy. Szukamy zale偶noci pomidzy tymi dwoma zmiennymi, wic u偶yjemy scatterplota i spr贸bujemy na nim dopasowania liniowego, aby wyoni jakie trendy. Dopasowanie liniowe zwraca wartoci rzeczywiste z przedziau \<-1,1\> i wyglda to tak:

-   Je偶eli ujemne -\> wraz ze wzrostem mocy ocena maleje. (korelacja ujemna)

-   Je偶eli 0 -\> brak zale偶noci czyli moc nie ma wpywu na ocen (to m贸wi hipoteza).

-   Je偶eli dodatnie -\> moc wpywa na wzrost oceny. (korelacja dodatnia)

```{r}
#| label: power-correlation-analysis-fixed

library(tidyverse)
library(kableExtra)
library(plotly)

# 1. Obliczenie wsp贸czynnika korelacji Pearsona
# U偶ywamy gotowej kolumny 'power' z data_cleaned
cor_val <- cor(data_cleaned$power, data_cleaned$rating, use = "complete.obs")



# 2. Wizualizacja: Wykres rozrzutu z lini trendu
p <- ggplot(data_cleaned, aes(x = power, y = rating)) +
  # Punkty: Zmniejszone i bardziej przezroczyste dla czytelnoci
  geom_jitter(aes(text = paste("Model:", car.brand, car.model, 
                               "<br>Power:", power, 
                               "<br>Rating:", rating)),
              alpha = 0.3, color = "#a64d79", size = 1.2) +
  # Linia trendu
  geom_smooth(method = "lm", color = "black", se = FALSE, linetype = "solid", size = 0.8) +
  theme_minimal() +
  labs(
    title = paste("Korelacja mocy z ocen:", round(cor_val, 2)),
    x = "Moc",
    y = "Ocena"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5)
  )

# Interaktywny wykres
ggplotly(p, tooltip = "text")

```

Wsp贸czynnik korelacji jest dodatni, czyli wiksza moc rzeczywicie wpywa pozytywnie na ocen samochodu, ale jak bardzo? Warto 0.32 w tym kontekcie to bardzo solidna zale偶no, zwa偶ajc, 偶e na ocene wpywa bardzo wiele czynnik贸w opr贸cz samej mocy. Widzimy wic, 偶e moc jest do wa偶nym czynnikem wpywajcym na ocen.

### Jedno ale

Zwyczajne dopasowanie liniowe pokazuje pewien trend, natomiast przedzia mocy od ekonomicznych samochodzik贸w miejskich a偶 do super szybkich samochod贸w sportowych jest bardzo szeroki i zacieraj si pewne wnioski.

Dlatego u偶yjemy podziau kwantylowego - dzielimy oceny na 5 r贸wnych przedzia贸w, ka偶dy po okoo 600 ocen. Dziki temu nie patrzymy na wszystko jako jedn cao, a na r贸偶ne grupy samochod贸w do r贸偶nych zastosowa i jak to sie ma do korelacji mocy z ocen. Tym razem u偶ywamy dopasowania LOESS(Locally Estimated Scatterplot Smoothing), kt贸re poka偶e nam pynn i lokaln linie trendu, a nie tak dopasowan do wszystkich ocen na raz.

### Punkty odniesienia

Zanim zobaczymy drugi wykres, zobaczmy kilka samochod贸w o bardzo r贸偶nych stosunkach mocy do masy, 偶eby wiedzie jakie wartoci reprezentuj jak kategori samochod贸w.

:::::: columns
::: {.column width="49%"}
![Grupa 1, autka miejske (*power* = 6.9)](images/clipboard-1860880995.png){fig-alt="Grupa 1 (50-80KM)" fig-align="center" width="333"}
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
![Grupa 3, rodzinne samochody (*power* = 10.0)](images/clipboard-1224579198.png){fig-align="center" width="333"}
:::
::::::

:::::: columns
::: {.column width="49%"}
![Pocztek gr. 5, samochody komercyjne z wyra藕nym naciskiem na moc (power = 15.3)](images/clipboard-1957643697.png){fig-align="center" width="322"}
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
![Koniec gr.5, samochody wycigowe (power = 39.6)](images/clipboard-1948911523.png){fig-align="center" width="314"}
:::
::::::

```{r}
library(tidyverse)
library(plotly)

# --- 1. PRZYGOTOWANIE DANYCH ---
base_data <- data_cleaned %>%
  ungroup() %>%
  filter(!is.na(power), !is.na(rating)) %>%
  mutate(kwantyl_num = ntile(power, 5))

# --- 2. PRZYGOTOWANIE LEGENDY ---
ranges_summary <- base_data %>%
  group_by(kwantyl_num) %>%
  summarise(
    min_p = min(power),
    max_p = max(power),
    .groups = "drop"
  ) %>%
  mutate(
    range_label = paste0("Gr. ", kwantyl_num, ": ", min_p, " - ", max_p)
  ) %>%
  distinct(kwantyl_num, range_label) %>%
  arrange(kwantyl_num)

plot_data_final <- base_data %>%
  left_join(ranges_summary, by = "kwantyl_num") %>%
  mutate(kwantyl_f = factor(range_label, levels = unique(ranges_summary$range_label))) %>%
  mutate(tooltip_text = paste0(
    "<b>Model:</b> ", car.brand, " ", car.model, "<br>",
    "<b>Moc:</b> ", power, "<br>",
    "<b>Ocena:</b> ", rating, "<br>",
    "<b>Grupa:</b> ", range_label
  ))

# --- 3. KOLORY ---
my_colors <- c("#1f78b4", "#33a02c", "#984ea3", "#ff7f00", "#e31a1c")

# --- 4. BUDOWA WYKRESU GGPLOT ---
p <- ggplot(plot_data_final, aes(x = power, y = rating)) +

  # Punkty (mae na wykresie - size = 1.5)
  geom_jitter(aes(color = kwantyl_f, text = tooltip_text),
              alpha = 0.3, size = 1, shape = 16, width = 0.5) +

  # Linia LOESS
  geom_smooth(method = "loess", se = FALSE, color = "black", size = 1.2, n = 500) +

  scale_color_manual(values = my_colors, name = "Grupy mocy") +
  theme_minimal() +
  labs(
    title = "Analiza trendu (LOESS) w grupach kwantylowych",
    x = "Moc (power)",
    y = "Ocena (rating)"
  ) +
  theme(plot.title = element_text(face = "bold"))

# --- 5. KONWERSJA DO PLOTLY Z NAPRAW LEGENDY ---
interactive_plot <- ggplotly(p, tooltip = "text") %>%
  layout(
    legend = list(
      title = list(text = "<b>Przedziay kwantylowe</b>"),
      # --- KLUCZOWA ZMIANA ---
      # "constant" wymusza, by punkty w legendzie byy du偶e i wyra藕ne,
      # ignorujc may rozmiar punkt贸w na wykresie.
      itemsizing = "constant"
    )
  )

interactive_plot
```

Teraz wyglda to zupenie inaczej. Dla samochod贸w o mocach rednich i maych(gr. 1,2,3) mamy bardzo sabe zale偶noci. Na tyle mae, 偶e mo偶na by bezpiecznie uzna, 偶e to zwyczajny szum i dla samochod贸w miejskich lub "komercyjnych" moc nie ma wielkiego wpywu na ocen. Natomiast sytuacja drastycznie zmienia si gdy wchodzimy w terytorium samochod贸w sportowych i bardzo mocnych "komercyjnych". Linia trendu nagle ronie od koca 4 grupy mocy. Wida do logiczn zale偶no: gdy znajdujemy si w sekcji sportowej to moc zaczyna mie ogrome znaczenie i jej dostatek cieszy oceniajcych.

### *Wnioski:* {#sec-wnioski4}

Hipoteza sprawdza si tylko w grupie aut sportowych i komercyjnych klasy premium/sport. Dla pozostaych samochod贸w moc nie ma wikszego wpywu na ocen. [podsumowanie](#podsumowanie)

## Podsumowanie {#podsumowanie}

Z naszego zbioru danych udao nam si wycign kilka ciekawych i praktycznych wniosk贸w. Z pierwszego wniosku @sec-wnioski1 dowiadujemy si 偶e,

::: {#refs}
:::
